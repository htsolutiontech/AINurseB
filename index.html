<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nursing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .role-hidden { display: none !important; }
        .active-tab { border-left: 4px solid #2563eb; background: #eff6ff; color: #1d4ed8; }
        .modal-active { display: flex !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="login-modal" class="fixed inset-0 bg-slate-900/90 flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border border-slate-200">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-stethoscope text-blue-600 text-3xl"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">AI NURSING</h2>
                <p class="text-slate-500 text-sm">Hệ thống chăm sóc Xương khớp & PHCN</p>
            </div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Chọn quyền truy cập</label>
            <select id="role-select" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-6 bg-slate-50 focus:border-blue-500 outline-none transition-all">
                <option value="admin">Giám đốc (Full Access)</option>
                <option value="doctor">Bác sĩ (Lâm sàng & Giám sát)</option>
                <option value="nurse" selected>Điều dưỡng (Đi buồng & Chăm sóc)</option>
                <option value="it">Kỹ thuật viên IT (Hệ thống & Log)</option>
            </select>
            <button onclick="login()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95">ĐĂNG NHẬP</button>
        </div>
    </div>

    <div id="main-app" class="hidden flex h-screen overflow-hidden">
        
        <aside class="w-72 bg-white border-r border-slate-200 flex flex-col">
            <div class="p-8">
                <div class="flex items-center space-x-3 mb-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-brain text-white text-xs"></i>
                    </div>
                    <h1 class="text-lg font-black tracking-tighter">AI CARE</h1>
                </div>
                <p id="role-badge" class="text-[10px] bg-blue-50 text-blue-600 font-bold px-2 py-1 rounded-md inline-block"></p>
            </div>

            <nav class="flex-1 px-4 space-y-1">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="w-full flex items-center px-4 py-3 rounded-xl active-tab transition-all">
                    <i class="fas fa-th-large mr-3 w-5"></i> <span class="text-sm font-bold">Bảng điều khiển</span>
                </button>
                <button onclick="switchTab('ward')" id="btn-ward" class="w-full flex items-center px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                    <i class="fas fa-walking mr-3 w-5"></i> <span class="text-sm font-bold">Chế độ Đi buồng AI</span>
                </button>
                <button onclick="switchTab('patients')" id="btn-patients" class="w-full flex items-center px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                    <i class="fas fa-user-injured mr-3 w-5"></i> <span class="text-sm font-bold">Hồ sơ Bệnh nhân</span>
                </button>
                <button onclick="switchTab('it-config')" id="btn-it" class="role-hidden w-full flex items-center px-4 py-3 text-slate-500 hover:bg-slate-50 rounded-xl transition-all">
                    <i class="fas fa-microchip mr-3 w-5"></i> <span class="text-sm font-bold">Cấu hình & Bảo mật</span>
                </button>
            </nav>

            <div class="p-6 border-t border-slate-100">
                <button onclick="location.reload()" class="w-full flex items-center justify-center p-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-all text-sm">
                    <i class="fas fa-power-off mr-2"></i> Đăng xuất
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col bg-slate-50 overflow-hidden">
            <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
                <h2 id="tab-title" class="text-xl font-black text-slate-800 uppercase tracking-tight">Dashboard</h2>
                <div class="flex items-center space-x-6">
                    <div class="relative">
                        <i class="fas fa-bell text-slate-300 text-xl"></i>
                        <span id="alert-dot" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 border-2 border-white rounded-full"></span>
                    </div>
                    <div class="flex items-center space-x-3 bg-slate-50 px-4 py-2 rounded-2xl border border-slate-100">
                        <div class="text-right">
                            <p class="text-[10px] font-bold text-slate-400 uppercase leading-none">Máy chủ</p>
                            <p class="text-xs font-bold text-green-500 leading-none mt-1">Sẵn sàng (Local)</p>
                        </div>
                        <i class="fas fa-database text-slate-300"></i>
                    </div>
                </div>
            </header>

            <div id="tab-container" class="p-8 overflow-y-auto flex-1">
                <div id="tab-dashboard" class="tab-content space-y-8">
                    <div class="grid grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                            <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Dữ liệu nạp</p>
                            <h3 id="stat-total" class="text-3xl font-black text-slate-800">0</h3>
                            <button onclick="document.getElementById('fileInput').click()" class="mt-4 text-xs font-bold text-blue-600 flex items-center">
                                <i class="fas fa-plus-circle mr-1"></i> Tải JSONL mới
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-red-50 shadow-sm">
                            <p class="text-red-400 text-[10px] font-black uppercase mb-1">Cảnh báo đỏ (ICNP)</p>
                            <h3 id="stat-alert" class="text-3xl font-black text-red-600">0</h3>
                            <div class="mt-4 h-1 w-full bg-red-50 rounded-full overflow-hidden">
                                <div id="alert-progress" class="h-full bg-red-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                            <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Tiết kiệm Admin</p>
                            <h3 id="stat-time" class="text-3xl font-black text-emerald-500">0h</h3>
                            <p class="text-[10px] text-slate-400 mt-2">Giảm 65% thời gian ghi chép</p>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                            <p class="text-slate-400 text-[10px] font-black uppercase mb-1">Tuân thủ HIPAA</p>
                            <h3 class="text-xl font-black text-blue-800">100%</h3>
                            <div class="flex space-x-1 mt-4">
                                <div class="w-2 h-2 rounded-full bg-blue-500"></div>
                                <div class="w-2 h-2 rounded-full bg-blue-300"></div>
                                <div class="w-2 h-2 rounded-full bg-blue-100"></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                            <div class="flex items-center bg-slate-50 px-4 py-2 rounded-xl w-80">
                                <i class="fas fa-search text-slate-300 mr-2 text-sm"></i>
                                <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Tìm hồ sơ..." class="bg-transparent text-sm outline-none w-full">
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="changePage(-1)" id="prevBtn" class="w-10 h-10 flex items-center justify-center border rounded-xl hover:bg-slate-50 disabled:opacity-30"><i class="fas fa-chevron-left"></i></button>
                                <span id="pageInfo" class="text-xs font-bold text-slate-500 px-4">Trang 1</span>
                                <button onclick="changePage(1)" id="nextBtn" class="w-10 h-10 flex items-center justify-center border rounded-xl hover:bg-slate-50 disabled:opacity-30"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <table class="w-full">
                            <thead class="bg-slate-50/50 text-[10px] font-black text-slate-400 uppercase">
                                <tr>
                                    <th class="px-6 py-4 text-left">ID & Mã ICNP</th>
                                    <th class="px-6 py-4 text-left">Chỉ số ROM/VAS</th>
                                    <th class="px-6 py-4 text-left">AI Triage</th>
                                    <th class="px-6 py-4 text-center">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-ward" class="tab-content hidden max-w-2xl mx-auto space-y-6">
                    <div class="bg-blue-600 p-8 rounded-[40px] text-white shadow-xl shadow-blue-100 relative overflow-hidden">
                        <i class="fas fa-microphone absolute -right-4 -bottom-4 text-8xl text-white/10"></i>
                        <h3 class="text-2xl font-black mb-2">Trợ lý Đi buồng AI</h3>
                        <p class="text-blue-100 text-sm">Ghi chép nhanh bằng giọng nói & Nhận diện hình ảnh vết mổ</p>
                    </div>
                    
                    <div class="bg-white p-8 rounded-[40px] border border-slate-100 space-y-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Chọn Bệnh nhân đang thăm khám</label>
                            <select class="w-full p-4 bg-slate-50 border-none rounded-2xl font-bold">
                                <option>BN-7742 (Thay khớp gối P - Ngày 3)</option>
                                <option>BN-8821 (Phẫu thuật cột sống - Ngày 1)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-4 bg-emerald-50 rounded-3xl border border-emerald-100">
                                <p class="text-[10px] font-bold text-emerald-600 uppercase">Biên độ ROM</p>
                                <input type="number" value="45" class="bg-transparent text-2xl font-black w-full outline-none text-emerald-700">
                            </div>
                            <div class="p-4 bg-red-50 rounded-3xl border border-red-100">
                                <p class="text-[10px] font-bold text-red-600 uppercase">Mức độ Đau (VAS)</p>
                                <input type="number" value="7" class="bg-transparent text-2xl font-black w-full outline-none text-red-700">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-3">Ghi chú AI (Voice-to-Text)</label>
                            <div class="relative">
                                <textarea class="w-full p-5 bg-slate-50 border-none rounded-3xl text-sm min-h-[120px] outline-none focus:ring-2 ring-blue-500" placeholder="AI đang lắng nghe... Ví dụ: Vết mổ khô, sưng nhẹ, bệnh nhân đã tập đi được 10m."></textarea>
                                <button class="absolute bottom-4 right-4 w-12 h-12 bg-red-500 text-white rounded-full flex items-center justify-center animate-pulse">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                        </div>
                        <button class="w-full bg-slate-900 text-white p-5 rounded-3xl font-bold flex items-center justify-center space-x-2">
                            <i class="fas fa-magic"></i>
                            <span>AI TỰ ĐỘNG LẬP KẾ HOẠCH CHĂM SÓC</span>
                        </button>
                    </div>
                </div>

                <div id="tab-patients" class="tab-content hidden space-y-6">
                    <div class="grid grid-cols-3 gap-6" id="patient-grid">
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <div class="w-12 h-12 bg-blue-100 rounded-full mb-4 flex items-center justify-center text-blue-600 font-bold">BN</div>
                            <h4 class="font-bold">Bệnh nhân ID #4421</h4>
                            <p class="text-xs text-slate-400">Thay khớp háng • 65 tuổi</p>
                            <div class="mt-4 pt-4 border-t flex justify-between">
                                <span class="text-[10px] font-bold text-emerald-500 bg-emerald-50 px-2 py-1 rounded">ỔN ĐỊNH</span>
                                <button class="text-blue-600 text-xs font-bold">Xem bệnh án</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-it-config" class="tab-content hidden space-y-6">
                    <div class="bg-slate-900 p-8 rounded-[40px] text-white">
                        <h3 class="text-xl font-bold mb-4 italic font-mono">> System Integrity Check</h3>
                        <div class="space-y-2 font-mono text-xs text-emerald-400">
                            <p>[OK] AES-256 E2EE Encryption Layer Active</p>
                            <p>[OK] ICNP Taxonomy mapping: 15,000 rules loaded</p>
                            <p>[OK] Database: No external leaks detected (Local-first)</p>
                            <p>[LOG] Session started for user: <span id="log-user"></span></p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-3xl border">
                            <h4 class="font-bold mb-4">Kết nối API & HL7</h4>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl mb-2">
                                <span class="text-xs font-bold">HIS Integration</span>
                                <div class="w-10 h-5 bg-emerald-500 rounded-full relative"><div class="absolute right-1 top-1 w-3 h-3 bg-white rounded-full"></div></div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                                <span class="text-xs font-bold">E-Consent Digital Sign</span>
                                <div class="w-10 h-5 bg-slate-300 rounded-full relative"><div class="absolute left-1 top-1 w-3 h-3 bg-white rounded-full"></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="record-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden items-center justify-center z-[200] p-4">
        <div class="bg-white w-full max-w-2xl rounded-[40px] overflow-hidden shadow-2xl">
            <div id="modal-header" class="p-8 text-white flex justify-between items-start">
                <div>
                    <p class="text-[10px] font-black uppercase opacity-60 mb-1">Chi tiết Hồ sơ y tế</p>
                    <h3 id="modal-id" class="text-2xl font-black">ID: #0000</h3>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center hover:bg-white/40 transition-all"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 space-y-6 overflow-y-auto max-h-[70vh]">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 rounded-3xl border border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase">Chỉ số Lâm sàng</p>
                        <div class="flex items-end space-x-4 mt-2">
                            <div><span id="modal-rom" class="text-3xl font-black text-slate-800">0</span><span class="text-xs font-bold ml-1 text-slate-400">° ROM</span></div>
                            <div><span id="modal-vas" class="text-3xl font-black text-slate-800">0</span><span class="text-xs font-bold ml-1 text-slate-400">/10 VAS</span></div>
                        </div>
                    </div>
                    <div id="modal-icnp-card" class="p-4 rounded-3xl border">
                        <p id="modal-icnp-code" class="text-[10px] font-bold uppercase mb-1">ICNP: --</p>
                        <h4 id="modal-icnp-name" class="font-black text-sm">--</h4>
                    </div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Phân tích AI & Khuyến nghị</h4>
                    <div id="modal-ai-reason" class="p-5 bg-blue-50 text-blue-700 rounded-3xl text-sm italic border border-blue-100"></div>
                </div>
                <div class="p-5 bg-slate-900 rounded-3xl text-white">
                    <h4 class="text-[10px] font-bold opacity-50 uppercase mb-2 text-emerald-400 italic">Nursing Intervention Plan</h4>
                    <p id="modal-notes" class="text-sm leading-relaxed"></p>
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex space-x-4">
                <button class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold text-sm shadow-lg shadow-blue-100">IN PHIẾU CHĂM SÓC</button>
                <button onclick="closeModal()" class="flex-1 bg-white border border-slate-200 text-slate-500 py-4 rounded-2xl font-bold text-sm">ĐÓNG</button>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept=".jsonl">

    <script>
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let currentUser = null;

        function login() {
            currentUser = document.getElementById('role-select').value;
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('role-badge').innerText = `ROLE: ${currentUser}`;
            document.getElementById('log-user').innerText = currentUser;

            // Apply Roles
            if(['admin', 'it'].includes(currentUser)) {
                document.getElementById('btn-it').classList.remove('role-hidden');
            }
            if(currentUser === 'nurse') {
                switchTab('ward');
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.getElementById(`btn-${tabId}`).classList.add('active-tab');
            document.getElementById('tab-title').innerText = tabId.replace('-', ' ');
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const lines = event.target.result.split('\n');
                allData = lines.filter(l => l.trim() !== '').map(l => JSON.parse(l));
                filteredData = [...allData];
                updateStats();
                renderTable();
            };
            reader.readAsText(file);
        });

        function updateStats() {
            document.getElementById('stat-total').innerText = allData.length.toLocaleString();
            const alerts = allData.filter(d => d.form_data.mục_9_alert.is_alert);
            document.getElementById('stat-alert').innerText = alerts.length.toLocaleString();
            
            const alertPct = (alerts.length / allData.length) * 100;
            document.getElementById('alert-progress').style.width = alertPct + '%';
            document.getElementById('alert-dot').classList.toggle('hidden', alerts.length === 0);
            
            // Time saved logic (40 min per record)
            const hoursSaved = Math.round((allData.length * 40) / 60);
            document.getElementById('stat-time').innerText = hoursSaved.toLocaleString() + 'h';
        }

        function renderTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            filteredData = allData.filter(d => 
                d.id.toLowerCase().includes(query) || 
                d.form_data.mục_9_alert.reason.toLowerCase().includes(query)
            );

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            pageData.forEach(item => {
                const isAlert = item.form_data.mục_9_alert.is_alert;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50/80 transition-all cursor-pointer";
                tr.innerHTML = `
                    <td class="px-6 py-5">
                        <p class="text-xs font-black text-slate-700">#${item.id.substring(0,8)}</p>
                        <p class="text-[9px] text-slate-400 font-bold">${isAlert ? 'ICNP 10015133' : 'ICNP 10015123'}</p>
                    </td>
                    <td class="px-6 py-5">
                        <div class="flex items-center space-x-3">
                            <span class="text-sm font-black text-blue-600">${item.form_data.mục_4_indicators.rom}°</span>
                            <span class="text-[10px] text-slate-300">|</span>
                            <span class="text-sm font-black ${item.form_data.mục_4_indicators.vas > 5 ? 'text-red-500' : 'text-slate-700'}">${item.form_data.mục_4_indicators.vas}/10 VAS</span>
                        </div>
                    </td>
                    <td class="px-6 py-5">
                        <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${isAlert ? 'bg-red-100 text-red-600' : 'bg-emerald-100 text-emerald-600'}">
                            ${isAlert ? 'Cần can thiệp' : 'Ổn định'}
                        </span>
                    </td>
                    <td class="px-6 py-5 text-center">
                        <button onclick="openModal('${item.id}')" class="text-blue-600 hover:text-blue-800 font-black text-xs uppercase tracking-widest">Chi tiết</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('pageInfo').innerText = `Trang ${currentPage} / ${Math.ceil(filteredData.length / itemsPerPage) || 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage >= Math.ceil(filteredData.length / itemsPerPage);
        }

        function openModal(id) {
            const data = allData.find(d => d.id === id);
            const isAlert = data.form_data.mục_9_alert.is_alert;
            
            document.getElementById('modal-id').innerText = `ID: #${data.id.substring(0,12)}`;
            document.getElementById('modal-header').className = `p-8 flex justify-between items-start ${isAlert ? 'bg-red-500' : 'bg-blue-600'}`;
            document.getElementById('modal-rom').innerText = data.form_data.mục_4_indicators.rom;
            document.getElementById('modal-vas').innerText = data.form_data.mục_4_indicators.vas;
            
            document.getElementById('modal-icnp-code').innerText = isAlert ? 'ICNP: 10015133' : 'ICNP: 10015123';
            document.getElementById('modal-icnp-name').innerText = isAlert ? 'Nguy cơ nhiễm trùng vết mổ' : 'Khả năng vận động thể chất ổn định';
            document.getElementById('modal-icnp-card').className = `p-4 rounded-3xl border ${isAlert ? 'bg-red-50 border-red-100 text-red-700' : 'bg-emerald-50 border-emerald-100 text-emerald-700'}`;
            
            document.getElementById('modal-ai-reason').innerText = `AI Insights: ${data.form_data.mục_9_alert.reason}. Khuyến nghị theo dõi sát biên độ khớp và tình trạng sưng nề.`;
            document.getElementById('modal-notes').innerText = data.form_data.mục_10_notes + " Kế hoạch tiếp theo: Duy trì bài tập PHCN mức độ 2, kiểm tra lại sau 4 giờ.";
            
            document.getElementById('record-modal').classList.add('modal-active');
        }

        function closeModal() {
            document.getElementById('record-modal').classList.remove('modal-active');
        }

        function changePage(dir) {
            currentPage += dir;
            renderTable();
        }

        // Initialize simulation
        console.log("AI Nursing CMS: Ready. HIPAA & ICNP Compliance modules loaded.");
    </script>
</body>
</html>